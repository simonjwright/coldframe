# Copyright (c) 2001 Simon Wright <simon@pushface.org>
# $Id$

# Makefile for use with Cygwin under Windows.

GENERATE_ACCESSORS = defined

TOP = d:

CF = $(TOP)/cf-DATE

AWK = awk
ITCLSH = $(TOP)/Tcl/bin/itclsh31
TCLXML = $(TOP)/TclXML-1.2

SAXON = $(TOP)/Saxon/saxon

ESCAPE_MARKUP_SCRIPT = $(CF)/escape-markup.awk
NORMALIZE_ROSE_SCRIPT = $(CF)/normalize-rose.tcl
HTMLGEN_SCRIPT = $(CF)/generate-html.xsl
CODEGEN_SCRIPT = $(CF)/generate-ada.xsl

%.norm: %.raw
	$(AWK) -f $(ESCAPE_MARKUP_SCRIPT) <$< | \
	TCLLIBPATH=$(TCLXML) $(ITCLSH) $(NORMALIZE_ROSE_SCRIPT) \
	  --version cf-DATE \
	  >$@ || rm -f $@

%.html: %.norm
	$(SAXON) $< $(HTMLGEN_SCRIPT) >$@ || rm -f $@

%.ada: %.norm
	$(SAXON) $< $(CODEGEN_SCRIPT) >$@  \
	  coldframe-version=cf-DATE \
	  generate-accessors=$(GENERATE_ACCESSORS) >$@  \
	  || (echo "Generation problem." && rm -f $@)

# Create the target directory
# get rid of any files in it already
# gnatchop the .ada file
# remove any generated files which are also present in the implementation
# directory (.impl)
# write-protect the generated files
%.gen: %.ada
	-mkdir $@
	rm -f $@/*.ad[bs]
	gnatchop -gnatX $< $@
	[ ! -d $*.impl ] || for f in `(cd $*.impl; ls *.ad?)`; do \
	   [ ! -f $@/$$f ] || ( echo rm $@/$$f; rm $@/$$f); \
	done
	chmod a=r $@/*.ad[bs]

.PHONY: force

#;; for emacs:
#;; Local Variables:
#;; mode: makefile
#;; End:
