#  Copyright (C) Simon Wright <simon@pushface.org>

#  This package is free software; you can redistribute it and/or
#  modify it under terms of the GNU General Public License as
#  published by the Free Software Foundation; either version 2, or
#  (at your option) any later version. This package is distributed in
#  the hope that it will be useful, but WITHOUT ANY WARRANTY; without
#  even the implied warranty of MERCHANTABILITY or FITNESS FOR A
#  PARTICULAR PURPOSE. See the GNU General Public License for more
#  details. You should have received a copy of the GNU General Public
#  License distributed with this package; see file COPYING.  If not,
#  write to the Free Software Foundation, 59 Temple Place - Suite
#  330, Boston, MA 02111-1307, USA.

# $Id$

# Makefile for tests, use with Cygwin under Windows or Unix (assumes a
# Unix system if Cygwin not detected).

# It's assumed that no project-special settings are in place and that
# the command 'gnatmake' will compile and generate an executable.

# It's assumed that this is still a subdirectory of the ColdFrame
# install directory, and that we have write access (OK on Windows,
# may require admin cooperation on Unix).

all::
clean::

sys = $(shell uname)
ifneq (, $(findstring CYGWIN, $(sys)))
  system = winnt
  exe = .exe
else
  system = unix
  exe =
endif

cf = $(TOP)/$(COLDFRAME)

parent = $(cf)/Makefile-$(system)

include $(parent)

app = ADA_PROJECT_PATH=$(cf)

all:: build-dirs runs fails
clean::
	find $(BUILD_BASE) -type f -name \*.o -o -name \*.ali | xargs rm -f

runs:: event_test-harness$(exe)
	./$< -v 2>&1 | tee -a event_test.log

runs:: hierarchies-harness$(exe)
	./$< -v 2>&1 | tee -a hierarchies.log

runs:: initialization-harness$(exe)
	./$< -v 2>&1 | tee -a initialization.log

runs:: regression_tests$(exe)
	./$< -v 2>&1 | tee -a regressions.log

runs:: stub_test_harness$(exe)
	./$< -v 2>&1 | tee -a stub_test.log

runs:: unit_testing-harness$(exe)
	./$< -v 2>&1 | tee -a unit_testing.log

fails:: Bad_Model_Regressions.gen

fails:: Bad_Code_Regressions.gen

event_test-harness$(exe): Event_Test.gen force
	$(app) gnatmake -PEvent_Test 2>&1 | tee -a event_test.log
clean::
	-rm event_test-harness$(exe)

hierarchies-harness$(exe): Hierarchies.gen force
	$(app) gnatmake -PHierarchies 2>&1 | tee -a hierarchies.log
clean::
	-rm hierarchies-harness$(exe)

initialization-harness$(exe): Initialization.gen force
	$(app) gnatmake -PInitialization 2>&1 | tee -a initialization.log
clean::
	-rm initialization-harness$(exe)

regression_tests$(exe): Regressions.gen Compilation_Regressions.gen force
	$(app) gnatmake -PRegressions 2>&1 | tee -a regressions.log
clean::
	-rm regression_tests$(exe)

stub_test_harness$(exe): Stub_Test_Interface.gen force
	$(app) gnatmake -PStub_Test 2>&1 | tee -a stub_test.log
clean::
	-rm stub_test_harness$(exe)

unit_testing-harness$(exe): Unit_Testing.gen force
	$(app) gnatmake -PUnit_Testing 2>&1 | tee -a unit_testing.log
clean::
	-rm unit_testing-harness$(exe)

Compilation_Regressions.gen: Compilation_Regressions.norm
	$(MAKE) -f $(parent) $@ 2>&1 | tee regressions.log
clean::
	-rm -rf Compilation_Regressions.{ada,gen,norm,raw}

Event_Test.gen: Event_Test.norm
	$(MAKE) -f $(parent) $@ 2>&1 | tee event_test.log
clean::
	-rm -rf Event_Test.{ada,gen,norm,raw}

Hierarchies.gen: Hierarchies.norm
	$(MAKE) -f $(parent) $@ 2>&1 | tee hierarchies.log
clean::
	-rm -rf Hierarchies.{ada,gen,norm,raw}

Initialization.gen: Initialization.norm
	$(MAKE) -f $(parent) $@ 2>&1 | tee initialization.log
clean::
	-rm -rf Initialization.{ada,gen,norm,raw}

Regressions.gen: Regressions.norm
	$(MAKE) -f $(parent) $@ 2>&1 | tee regressions.log
clean::
	-rm -rf Regressions.{ada,gen,norm,raw}

Stub_Test_Interface.gen: Stub_Test_Interface.norm
	$(MAKE) -f $(parent) $@ GENERATE_STUBS=yes 2>&1 | tee stub_test.log
clean::
	-rm -rf Stub_Test_Interface.{ada,gen,norm,raw}

Unit_Testing.gen: Unit_Testing.norm
	$(MAKE) -f $(parent) $@ UNIT_TEST_SUPPORT=yes 2>&1 |\
	   tee unit_testing.log
clean::
	-rm -rf Unit_Testing.{ada,gen,norm,raw}

Bad_Model_Regressions.gen: Bad_Model_Regressions.norm
	-$(MAKE) -f $(parent) $@ 2>&1 | tee bad_model_regressions.log
	@true
clean::
	-rm -rf Bad_Model_Regressions.{ada,gen,norm,raw}

Bad_Code_Regressions.gen: Bad_Code_Regressions.norm
	-$(MAKE) -f $(parent) $@ 2>&1 | tee bad_code_regressions.log
	@true
clean::
	-rm -rf Bad_Code_Regressions.{ada,gen,norm,raw}

$(COLDFRAMEOUT)/%.raw: %.cat
	python $(cf)/cat2raw.py -o$@  $<

.PHONY: force clean

#;; for emacs:
#;; Local Variables:
#;; mode: makefile
#;; End:
